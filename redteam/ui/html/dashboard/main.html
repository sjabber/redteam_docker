<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="theme-color" content="#FFFFFF">
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no" name="viewport">
    <title>REDTEAM | 대시보드</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nunito|Roboto">
    <link rel="stylesheet" href="https://maxcdn.icons8.com/fonts/line-awesome/1.1/css/line-awesome.min.css">
    <link rel="stylesheet" href="/css/sport.css" type="text/css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.2.1/css/bootstrap-grid.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>

</head>
<body>
<!--네이게이터-->
<div class="sidebar">
    <div class="sidebar-header"><a href="#">
        <img src="/image/intro_icon.png" style="max-width: 80%; height: auto;"
             onClick="location.href='/dashboard/total'"/>
    </a>
        <div class="sidebar-control"><i class="la la-navicon"></i></div>
    </div>
    <div class="sidebar-wrapper">
        <ul class="list-menu">
            <li class="header">Total Info</li>

            <li class="tree-item active"><a href="/dashboard/total"><i class="la la-group"></i><span>대시보드</span>
                <div class="right-container"></div>
            </a>

            <li class="header">Project Info</li>
            <li class="tree-item"><a href="/project/progress"><i class="la la-group"></i><span>프로젝트 관리</span>
                <div class="right-container"></div>
            </a>
            <li class="tree-item"><a href="/manager/target"><i class="la la-group"></i><span>대상관리</span>
                <div class="right-container"></div>
            </a>

            </li>
            <li class="tree-item"><a href="/manager/template"><i class="la la-file-text"></i><span>템플릿관리</span>
                <div class="right-container"></div>
            </a>
            </li>
            <!--            <li class="tree-item"><a href="/project/create"><i class="la la-pencil-square"></i><span>프로젝트 생성</span>-->
            <!--                <div class="right-container"></div>-->
            <!--            </a>-->
            <!--            </li>-->
            <li class="header">Setting</li>
            <li class="has-children"><a href="javascript:;"><i class="la la-cog"></i><span>설정</span>
                <div class="right-container"><i class="la la-chevron-right tree-icon"></i></div>
            </a>
                <ul class="tree">
                    <li class="tree-item"><a href="/setting/user"><i
                            class="la la-circle"></i><span style="font-size:0.8em;">사용자 정보</span></a></li>
                    <li class="tree-item"><a href="/setting/smtp"><i
                            class="la la-circle"></i><span style="font-size:0.8em;">SMTP 설정</span></a></li>
                </ul>
            </li>
            <li class="header">Help</li>
            <li class="has-children"><a href="javascript:"><i class="la la-question"></i><span>도움말</span>
                <div class="right-container"><i class="la la-chevron-right tree-icon"></i></div>
            </a>
                <ul class="tree">
                    <li class="tree-item"><a href="/help/project"><i
                            class="la la-circle"></i><span style="font-size:0.8em;">프로젝트 관리</span></a></li>
                    <li class="tree-item"><a href="/help/target"><i
                            class="la la-circle"></i><span style="font-size:0.8em;">대상 관리</span></a></li>
                    <li class="tree-item"><a href="/help/template"><i
                            class="la la-circle"></i><span style="font-size:0.8em;">템플릿 관리</span></a></li>
                    <li class="tree-item"><a href="/help/smtp"><i
                            class="la la-circle"></i><span style="font-size:0.8em;">SMTP 설정</span></a></li>
                </ul>
            </li>
        </ul>
    </div>
</div>
<!--네이게이터-->

<div class="main-content">
    <div class="header">
        <div class="left">
            <div class="breadcrumb"><span>대시보드</span><span>전체진행현황</span></div>
        </div>
        <ul class="right">
            <li class="header-user dropdown ml-4 mr-3"><a class="user-photo trigger-dropdown"><img class="user-img"
                                                                                                   src="/image/user.png"/></a>
                <div class="dropdown-box with-header">
                    <div class="dropdown-header"><img class="user-img user-img--lg"
                                                      src="/image/user.png"/>
                        <div class="user-info">
                            <h3 id="dropdown_name">name</h3><span class="helper-text" id="dropdown_id">email</span>
                        </div>
                    </div>
                    <ul class="dropdown-body">
                        <li><a href="/setting/user" target="_blank"><i
                                class="la la-user"></i><span>사용자 정보</span></a></li>
                        <li><a href="/setting/smtp"><i class="la la-cogs"></i><span>SMTP 설정</span></a></li>
                        <li><a href="javascript:Logout();"><i class="la la-power-off"></i><span>로그아웃</span></a></li>
                    </ul>
                </div>
            </li>
        </ul>
        <div class="right--mobile"><a class="header-item--mobile sidebar-control"><i class="la la-navicon"></i></a><a
                class="header-item--mobile"><i class="la la-comments"></i></a><a class="header-item--mobile"><i
                class="la la-ellipsis-v"></i></a></div>
    </div>
    <div class="content-wrapper">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-3">
                    <div class="card card-simple-1">
                        <div class="card-body"><i class="la la-users"></i>
                            <div class="card-content">
                                <h4>훈련 대상자</h4>
                                <p id="PI_1"></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-simple-1">
                        <div class="card-body"><i class="la la-calendar"></i>
                            <div class="card-content">
                                <h4>예약된 프로젝트</h4>
                                <p id="PI_2"></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-simple-1">
                        <div class="card-body"><i class="la la-calendar-check-o"></i>
                            <div class="card-content">
                                <h4>진행중인 프로젝트</h4>
                                <p id="PI_3"></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card card-simple-1">
                        <div class="card-body"><i class="la la-calendar-times-o"></i>
                            <div class="card-content">
                                <h4>종료된 프로젝트</h4>
                                <p id="PI_4"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="pgn-modal" style="width: 60%;
       height: 70%;
       margin:0 auto;
       /*display:table;*/
       position: absolute;
       left: 0;
       right:0;
       top: 40%;
       /*border:1px solid;*/
       -webkit-transform:translateY(-50%);
       -moz-transform:translateY(-50%);
       -ms-transform:translateY(-50%);
       -o-transform:translateY(-50%);
       transform:translateY(-50%);" id="result_viewer">
                <div class="pgn-modal-wrapper" style="height: 100%; overflow-y: auto">
                    <div class="modal__header">
                        <h3 style="text-align: center">악성메일 훈련 보고서</h3>
                        <div class="toolbox">
                            <button class="btn-modal-close" onclick="CloseResultViewer()"><i
                                    class="la la-times"></i></button>
                        </div>
                    </div>
                    <div class="modal__body">
                        <div class="form-group">
                            <h5>1. 프로젝트 정보</h5>
                            <table class="table--bordered" id="p_info">
                                <thead>
                                <tbody>
                                <tr>
                                    <td width="200">프로젝트명</td>
                                    <td class="font-weight-normal"></td>
                                </tr>
                                <tr>
                                    <td width="200">프로젝트 설명</td>
                                    <td class="font-weight-normal"></td>
                                </tr>
                                <tr>
                                    <td width="200">사용 템플릿</td>
                                    <td class="font-weight-normal"></td>
                                </tr>
                                <tr>
                                    <td width="200">유출 상태</td>
                                    <td class="font-weight-normal"></td>
                                </tr>
                                <tr>
                                    <td width="200">메일 전송률</td>
                                    <td class="font-weight-normal"></td>
                                </tr>
                                <tr>
                                    <td width="200">프로젝트 기간</td>
                                    <td class="font-weight-normal"></td>
                                </tr>
                                <tr>
                                    <td width="200">메일 전송 계정</td>
                                    <td class="font-weight-normal"></td>
                                </tr>
                                <tr>
                                    <td width="200">프로젝트 생성자</td>
                                    <td class="font-weight-normal"></td>
                                </tr>
                                <tr>
                                    <td width="200">훈련 대상자 태그</td>
                                    <td class="font-weight-normal">
                                </tr>
                                <tr>
                                    <td width="200">훈련 대상자 수</td>
                                    <td class="font-weight-normal"></td>
                                </tr>
                                <tr>
                                    <td width="200">발송</td>
                                    <td class="font-weight-normal"></td>
                                </tr>
                                <tr>
                                    <td width="200">발송 실패</td>
                                    <td class="font-weight-normal"></td>
                                </tr>
                                <tr>
                                    <td width="200">Email 열람</td>
                                    <td class="font-weight-normal"></td>
                                </tr>
                                <tr>
                                    <td width="200">Link 접속</td>
                                    <td class="font-weight-normal"></td>
                                </tr>
                                <tr>
                                    <td width="200">첨부파일 다운로드</td>
                                    <td class="font-weight-normal"></td>
                                </tr>
                                <tr>
                                    <td width="200">프로젝트 생성일</td>
                                    <td class="font-weight-normal"></td>
                                </tr>
                                <tr>
                                    <td width="200">프로젝트 최종 수정일</td>
                                    <td class="font-weight-normal"></td>
                                </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                            <br>
                            <br>
                            <h5>2. 프로젝트 요약</h5>
                            <h6>2.1 전체 프로젝트 결과</h6>
                            <div class="box-body pt-0 px-0 responsive">
                                <table class="table--bordered" id="totalResult">
                                    <thead>
                                    <tr>
                                        <th>분류</th>
                                        <th>정보 유출자 수</th>
                                        <th>정보 유출률</th>
                                        <th>상태</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>

                            <h6>2.2 분류 별 TOP 유출률</h6>
                            <div class="box-body pt-0 px-0 responsive">
                                <table class="table--bordered" id="resultPerClassification">
                                    <thead>
                                    <tr>
                                        <th>분류</th>
                                        <th>대상</th>
                                        <th>정보 유출자 수</th>
                                        <th>정보 유출률</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>


                            <br>
                            <br>
                            <h5>3. 프로젝트 결과 통계</h5>
                            <h6>3.1 태그별 통계</h6>
                            <div class="box-body pt-0 px-0 responsive">
                                <table class="table--bordered" id="perTag">
                                    <thead>
                                    <tr>
                                        <th width="200">태그</th>
                                        <th>유출률(%)</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>

                            <h6>3.2 소속별 통계</h6>
                            <div class="box-body pt-0 px-0 responsive">
                                <table class="table--bordered" id="perOrgan">
                                    <thead>
                                    <tr>
                                        <th width="200">소속</th>
                                        <th>유출률(%)</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr>
                                        <td>구글</td>
                                        <td>
                                            <progress class="valign-middle" value="5" max="15"></progress>
                                            33%(5/15명)
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>네이버</td>
                                        <td>
                                            <progress class="valign-middle" value="1" max="5"></progress>
                                            20%(1/5명)
                                        </td>
                                    </tr>

                                    </tbody>
                                </table>
                            </div>

                            <h6>3.3 직급별 통계</h6>
                            <div class="box-body pt-0 px-0 responsive">
                                <table class="table--bordered" id="perPosition">
                                    <thead>
                                    <tr>
                                        <th width="200">직급</th>
                                        <th>유출률(%)</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr>
                                        <td>대리</td>
                                        <td>
                                            <progress class="valign-middle" value="5" max="15"></progress>
                                            33%(5/15명)
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>과장</td>
                                        <td>
                                            <progress class="valign-middle" value="1" max="5"></progress>
                                            20%(1/5명)
                                        </td>
                                    </tr>

                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="modal__footer">
                        <div class="modal__footer">
                            <button class="btn btn-ghost" onclick="CloseResultViewer()">취소</button>
                            <button class="btn btn-primary pull-right" id="project_reg"
                                    onclick="toExcel()" value="mer_project_report">
                                다운로드
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-8">
                    <div class="box" style="height: 94%; overflow: hidden">

                        <div class="box-header">
                            <h3 class="chip--floating">진행중인 프로젝트 현황</h3>
                        </div>


                        <div class="m-3">
                            <div class="form-select pgn-select">
                                <select name="selector">
                                    <option value="1" selected>원 그래프 차트보기</option>
                                    <!--                                    <option value="2">막대그래프 차트보기</option>-->
                                </select>
                            </div>
                        </div>
                        <div class="box-body" style="height: 100%">
                            <div class="canvas-wrapper pb-2" style="height: 300px; align-content: center;">
                                <p align="center" id="NoProject"><span style="border: 1px; font-size:15px;
                                         font-style: italic; font-weight: 100;">진행중인 프로젝트가 없습니다.</span></p>
                                <div class="row p-2" style="height: 100%; width: 100%; overflow-y: auto;">
                                    <div class="canvas-wrapper" style="margin: 0 auto">
                                        <canvas class="pie-chart" id="pie-chart-category"></canvas>
                                    </div>
                                    <div class="canvas-wrapper" style="margin: 0 auto">
                                        <canvas class="pie-chart" id="pie-chart-category1"></canvas>
                                    </div>
                                    <div class="canvas-wrapper" style="margin: 0 auto">
                                        <canvas class="pie-chart" id="pie-chart-category2"></canvas>
                                    </div>
                                    <div class="canvas-wrapper" style="margin: 0 auto">
                                        <canvas class="pie-chart" id="pie-chart-category3"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="box">
                        <div class="box-header no-border">
                            <h5 class="chip--floating">Info</h5>
                        </div>
                        <div class="box-body pt-0">
                            <table class="table--bordered" id="project_detail">
                                <thead>
                                <tbody>
                                <tr>
                                    <td width="200">사용 템플릿</td>
                                    <td class="font-weight-bold"></td>
                                </tr>
                                <tr>
                                    <td width="200">메일 제목</td>
                                    <td class="font-weight-bold"></td>
                                </tr>
                                <tr>
                                    <td width="200">메일 전송 계정</td>
                                    <td class="font-weight-bold"></td>
                                </tr>
                                <tr>
                                    <td width="200">훈련 기간</td>
                                    <td class="font-weight-bold"></td>
                                </tr>
                                <tr>
                                    <td width="200">훈련 대상자 태그</td>
                                    <td class="font-weight-bold">
                                </tr>
                                <tr>
                                    <td width="200">훈련 대상자 수</td>
                                    <td class="font-weight-bold"></td>
                                </tr>
                                <tr>
                                    <td width="200">전송</td>
                                    <td class="font-weight-bold"></td>
                                </tr>
                                <tr>
                                    <td width="200">열람</td>
                                    <td class="font-weight-bold"></td>
                                </tr>
                                <tr>
                                    <td width="200">접속</td>
                                    <td class="font-weight-bold"></td>
                                </tr>
                                <tr>
                                    <td width="200">감염</td>
                                    <td class="font-weight-bold"></td>
                                </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div class="box">
                        <div class="box-header">
                            <h3>전체 프로젝트</h3>
                            <div class="toolbox"><a><i class="la la-print"></i></a></div>
                        </div>
                        <div class="box-body pt-0 px-0 responsive" style="height: 300px; overflow: auto">
                            <table id="project_list">
                                <thead>
                                <tr>
                                    <th style="visibility:hidden;position:absolute;"></th>
                                    <th>프로젝트 No.</th>
                                    <th>프로젝트명</th>
                                    <th>상태</th>
                                    <th>종료일</th>
                                    <th>결과</th>
                                </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!--        <div class="footer"><span><b>Pugna</b> - Admin Template by <a href="https://github.com/aljazari-studio/pugna"-->
        <!--                                                                      target="_blank">Al Jazari Studio</a></span></div>-->
    </div>
</div>

<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
<script src="/js/jquery.serialize-object.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/demo.js"></script>
<script src="/js/script.js"></script>
<script>
    // 계정별 태그정보 (최대 5개)
    var tg_total = [5];

    function GetDashBoard_Info1() {
        const r = new XMLHttpRequest();
        r.open('GET', 'http://mert.koreacentral.cloudapp.azure.com:5000/api/getDashBoard_Info1', true);
        r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        r.withCredentials = true;
        r.onreadystatechange = function () {
            let rObj;
            if (r.readyState === 4) {
                if (r.status === 200) {
                    rObj = JSON.parse(r.responseText);
                    // console.log(r.responseText);

                    $('#PI_1').text(rObj.info1.targets);
                    $('#PI_2').text(rObj.info1.scheduled);
                    $('#PI_3').text(rObj.info1.ongoing);
                    $('#PI_4').text(rObj.info1.closed);

                } else if (r.status === 403) {
                    Refresh();
                    GetDashBoard_Info1();
                }
            }
        };
        r.send();
    }

    function GetDashBoard_Info2(number) {
        const r = new XMLHttpRequest();
        r.open('GET', 'http://mert.koreacentral.cloudapp.azure.com:5000/api/getDashBoard_Info2?p_num=' + number, true);
        r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        r.withCredentials = true;
        r.onreadystatechange = function () {
            let rObj;
            if (r.readyState === 4) {
                if (r.status === 200) {
                    rObj = JSON.parse(r.responseText);
                    // console.log(r.responseText)

                    if (rObj.project_detail != null) {
                        // table 비워주기
                        $('#project_detail > tbody').empty();
                        $('#title').empty();
                        $('#NoProject').empty();

                        // Note json 형식
                        // 사용템플릿, 메일제목, 메일전송계정, 훈련기간, 훈련대상자 태그, 훈련대상자 수, 발송, 열람, 감염
                        // tmp_no, mail_title, sender_email, start_date, end_date, tag_no, targets, send_no, reading,
                        // connect_no, infection

                        // 태그 분리작업
                        let full_tag = ''

                        // 그래프
                        let ctxPieCategory = document.getElementById("pie-chart-category");
                        let ctxPieCategory1 = document.getElementById("pie-chart-category1");
                        let ctxPieCategory2 = document.getElementById("pie-chart-category2");
                        let ctxPieCategory3 = document.getElementById("pie-chart-category3");

                        let s_per = rObj.project_detail.send_no; // 보낸 수
                        let r_per = rObj.project_detail.reading; // 읽은 수
                        let c_per = rObj.project_detail.connect_no // 접속 수
                        let i_per = rObj.project_detail.infection; // 감염된 수
                        let t_per = rObj.project_detail.targets; // 총 훈련 대상자

                        if (ctxPieCategory) {
                            ctxPieCategory.width = 180;
                            ctxPieCategory.height = 180;

                            var pieData = {
                                type: "doughnut",
                                data: {
                                    datasets: [
                                        {
                                            data: [t_per - s_per, s_per],
                                            backgroundColor: ["#b6cbe3", "#046abd"]//, "#FFCC54", "#F6554D"]
                                        }
                                    ],
                                    //labels: ["Sports", "Fashion", "Electronics", "Home & Garden"],
                                    labels: ["미 전송", "전송"]
                                },
                                options: {
                                    title: {
                                        display: true,
                                        text: '메일 전송 현황'
                                    },
                                    maintainAspectRatio: false,
                                    layout: {
                                        padding: {
                                            left: 0,
                                            right: 0,
                                            top: 10,
                                            bottom: 10
                                        }
                                    }
                                }
                            };

                            new Chart(ctxPieCategory.getContext("2d"), pieData);
                        }

                        if (ctxPieCategory1) {
                            ctxPieCategory1.width = 180;
                            ctxPieCategory1.height = 180;

                            var pieData = {
                                type: "doughnut",
                                data: {
                                    datasets: [
                                        {
                                            data: [t_per - r_per, r_per],
                                            backgroundColor: ["#f7ebcd", "#e7c502"]
                                        }
                                    ],
                                    labels: ["미 열람", "열람"]
                                },
                                options: {
                                    title: {
                                        display: true,
                                        text: '열람 현황'
                                    },
                                    maintainAspectRatio: false,
                                    layout: {
                                        padding: {
                                            left: 0,
                                            right: 0,
                                            top: 10,
                                            bottom: 10
                                        }
                                    }
                                }
                            };

                            new Chart(ctxPieCategory1.getContext("2d"), pieData);
                        }

                        if (ctxPieCategory2) {
                            ctxPieCategory2.width = 180;
                            ctxPieCategory2.height = 180;

                            var pieData = {
                                type: "doughnut",
                                data: {
                                    datasets: [
                                        {
                                            data: [t_per - c_per, c_per],
                                            backgroundColor: ["#f5d1b5", "#e87107"]
                                        }
                                    ],
                                    labels: ["미 접속", "접속"]
                                },
                                options: {
                                    title: {
                                        display: true,
                                        text: '접속 현황'
                                    },

                                    maintainAspectRatio: false,
                                    layout: {
                                        padding: {
                                            left: 0,
                                            right: 0,
                                            top: 10,
                                            bottom: 10
                                        }
                                    }
                                }
                            };

                            new Chart(ctxPieCategory2.getContext("2d"), pieData);
                        }

                        if (ctxPieCategory3) {
                            ctxPieCategory3.width = 180;
                            ctxPieCategory3.height = 180;

                            var pieData = {
                                type: "doughnut",
                                data: {
                                    datasets: [
                                        {
                                            data: [t_per - i_per, i_per],
                                            backgroundColor: ["#f5c4c1", "#ef1334"]
                                        }
                                    ],
                                    labels: ["미 감염", "감염"]
                                },
                                options: {
                                    title: {
                                        display: true,
                                        text: '감염 현황'
                                    },
                                    maintainAspectRatio: false,
                                    layout: {
                                        padding: {
                                            left: 0,
                                            right: 0,
                                            top: 10,
                                            bottom: 10
                                        }
                                    }
                                }
                            };

                            new Chart(ctxPieCategory3.getContext("2d"), pieData);
                        }

                        for (let i = 0; i < rObj.project_detail.tag_no.length; i++) {
                            if (rObj.project_detail.tag_no[i] !== "") {

                                if (tg_total[0] === rObj.project_detail.tag_no[i]) {
                                    full_tag += '<label id="label1">' + rObj.project_detail.tag_no[i] + '</label>'
                                } else if (tg_total[1] === rObj.project_detail.tag_no[i]) {
                                    full_tag += '<label id="label2">' + rObj.project_detail.tag_no[i] + '</label>'
                                } else if (tg_total[2] === rObj.project_detail.tag_no[i]) {
                                    full_tag += '<label id="label3">' + rObj.project_detail.tag_no[i] + '</label>'
                                } else if (tg_total[3] === rObj.project_detail.tag_no[i]) {
                                    full_tag += '<label id="label4">' + rObj.project_detail.tag_no[i] + '</label>'
                                } else if (tg_total[4] === rObj.project_detail.tag_no[i]) {
                                    full_tag += '<label id="label5">' + rObj.project_detail.tag_no[i] + '</label>'
                                }
                            }
                        }

                        if (full_tag === '') {
                            return
                        } else {

                            $('#title').append(
                                '<td style="text-align: center; font-size: x-large; font-weight: normal;' +
                                ' width: 100%; font-style: italic">' + rObj.project_detail.p_name + '</td>'
                            )

                            // 전송비율
                            let send_percentage = (rObj.project_detail.send_no / rObj.project_detail.targets) * 100;
                            send_percentage = parseInt(send_percentage);

                            // 열람비율
                            let reading_percentage = (rObj.project_detail.reading / rObj.project_detail.targets) * 100;
                            reading_percentage = parseInt(reading_percentage);

                            // 접속비율
                            let connect_percentage = (rObj.project_detail.connect_no / rObj.project_detail.targets) * 100;
                            connect_percentage = parseInt(connect_percentage);

                            // 감염비율
                            let infection_percentage = (rObj.project_detail.infection / rObj.project_detail.targets) * 100;
                            infection_percentage = parseInt(infection_percentage);


                            $('#project_detail > tbody:last').append(
                                '<tr>' +
                                '<td width="200">사용 템플릿</td>' +
                                '<td class="font-weight-bold">' + rObj.project_detail.tmp_name + '</td>' +
                                '</tr>' +
                                '<tr>' +
                                '<td width="200">메일 제목</td>' +
                                '<td class="font-weight-bold">' + rObj.project_detail.mail_title + '</td>' +
                                '</tr>' +
                                '<tr>' +
                                '<td width="200">메일 전송 계정</td>' +
                                '<td class="font-weight-bold">' + rObj.project_detail.sender_email + '</td>' +
                                '</tr>' +
                                '<tr>' +
                                '<td width="200">훈련 기간</td>' +
                                '<td class="font-weight-bold">' + rObj.project_detail.start_date +
                                "&nbsp;&nbsp;&nbsp;&nbsp;~&nbsp;&nbsp;&nbsp;&nbsp;" +
                                rObj.project_detail.end_date + '</td>' +
                                '</tr>' + // + rObjs.project_detail.end_date + '</td></tr>' +
                                '<tr>' +
                                '<td width="200">훈련 대상자 태그</td>' +
                                '<td class="font-weight-bold">' + full_tag + '</td>' +
                                '</tr>' +
                                '<tr>' +
                                '<td width="200">훈련 대상자 수</td>' +
                                '<td class="font-weight-bold">' + rObj.project_detail.targets + '</td>' +
                                '</tr>' +
                                '<tr>' +
                                '<td width="200">전송</td>' +
                                '<td class="font-weight-bold">' + rObj.project_detail.send_no +
                                "&nbsp;&nbsp;&nbsp;&nbsp;(" + send_percentage + "%)" + '</td>' +
                                '</tr>' +
                                '<tr>' +
                                '<td width="200">열람</td>' +
                                '<td class="font-weight-bold">' + rObj.project_detail.reading +
                                "&nbsp;&nbsp;&nbsp;&nbsp;(" + reading_percentage + "%)" + '</td>' +
                                '</tr>' +
                                '<td width="200">접속</td>' +
                                '<td class="font-weight-bold">' + rObj.project_detail.connect_no +
                                "&nbsp;&nbsp;&nbsp;&nbsp;(" + connect_percentage + "%)" + '</td>' +
                                '</tr>' +
                                '<tr>' +
                                '<td width="200">감염</td>' +
                                '<td class="font-weight-bold">' + rObj.project_detail.infection +
                                "&nbsp;&nbsp;&nbsp;&nbsp;(" + infection_percentage + "%)" + '</td>' +
                                '</tr>'
                            );
                        }

                    } else if (rObj.project_detail === null) {

                        //document.getElementById('under').style.background = "#f2eff1";
                        $('#project_list').append('<tr style="background-color:white"><td colspan="6" align="center">' +
                            '<div class="alert alert" style="background-color:white">' +
                            '<p align="center"><span style="border: 1px; font-size:15px;' +
                            'font-style: italic; font-weight: 100;">진행중인 프로젝트가 없습니다.</span></p>' +
                            '</div></td></tr>');
                    }
                } else if (r.status === 403) {
                    Refresh();
                    GetDashBoard_Info2(number);
                }
            }
        };
        r.send();
    }

    function GetDashBoard_Info3() {
        const r = new XMLHttpRequest();
        r.open('GET', 'http://mert.koreacentral.cloudapp.azure.com:5000/api/getDashBoard_Info3', true);
        r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        r.withCredentials = true;
        r.onreadystatechange = function () {
            let rObj;
            if (r.readyState === 4) {
                if (r.status === 200) {
                    rObj = JSON.parse(r.responseText);
                    // console.log(r.responseText)

                    if (rObj.project_list != null) {
                        // table 비워주기
                        $('#project_list > tbody').empty();

                        // No, 프로젝트명, 상태, 종료일, 결과(버튼)
                        // p_no ,p_name , p_status, end_date
                        for (let i = 0; i < rObj.project_list.length; i++) {
                            // 태그 분리작업
                            let status_tag = ''

                            if (rObj.project_list[i].p_status !== "") {
                                if (rObj.project_list[i].p_status === "0") {
                                    status_tag += '<label class="badge badge-green">' + '예약' + '</label>'
                                } else if (rObj.project_list[i].p_status === "1") {
                                    status_tag += '<label class="badge badge-blue">' + '진행중' + '</label>'
                                } else if (rObj.project_list[i].p_status === "2") {
                                    status_tag += '<label class="badge badge-red">' + '종료' + '</label>'
                                } else if (rObj.project_list[i].p_status === "3") {
                                    status_tag += '<label class="badge badge-info">' + '오류' + '</label>'
                                }
                            }

                            if (status_tag === '') {
                                return
                            } else {
                                if (i === 0) {
                                    GetDashBoard_Info2(rObj.project_list[0].p_no);
                                }

                                $('#project_list > tbody:last').append('<tr onclick="GetDashBoard_Info2(' + rObj.project_list[i].p_no + ')">'
                                    + '<td id=' + rObj.project_list[i].p_no
                                    + ' style="visibility:hidden;position:absolute;">'
                                    + rObj.project_list[i].p_no + '</td>'
                                    + '<td>' + '&nbsp;&nbsp;&nbsp;' + rObj.project_list[i].fake_no + '</td>'
                                    + '<td>' + rObj.project_list[i].p_name + '</td><td>' + status_tag + '</td>'
                                    + '<td>' + rObj.project_list[i].end_date + '</td>'
                                    + '<td><button class="btn btn-secondary" onclick="ResultViewer(' + rObj.project_list[i].p_no + ')">결과보기</button></td></tr>');
                            }
                        }
                    } else if (rObj.project_list === null) {
                        $('#project_list').append('<tr style="background-color:white"><td colspan="6" align="center">' +
                            '<div class="alert alert" style="background-color:white">' +
                            '<p align="center"><span style="border: 1px; font-size:15px;' +
                            'font-style: italic; font-weight: 100;">진행중인 프로젝트가 없습니다.</span></p>' +
                            '</div></td></tr>');
                    }
                } else if (r.status === 403) {
                    Refresh();
                    GetDashBoard_Info3();
                }
            }
        };
        r.send();
    }

    function ResultViewer(p_no) {
        GetResult(p_no);
        $("#result_viewer").show();
    }

    function CloseResultViewer() {
        $("#result_viewer").hide();
    }

    function GetResult(p_no) {
        //    todo GetResult api 구현해야함
        // console.log('GetResult : p_no -> ' + p_no)
        const r = new XMLHttpRequest();
        r.open('GET', 'http://mert.koreacentral.cloudapp.azure.com:5000/api/resultDetail?p_no=' + p_no, true);
        r.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        r.withCredentials = true;
        r.onreadystatechange = function () {
            let rObj;
            if (r.readyState === 4) {
                if (r.status === 200) {
                    rObj = JSON.parse(r.responseText);
                    if (rObj.resultDetail != null) {
                        // console.log(r.responseText)
                        emptyTable();

                        fullTag = ''
                        for (let i = 0; i < rObj.resultDetail.ProjectInfo.tag_array.length; i++) {

                            if (i === 0) {
                                fullTag += "<label id=\"label1\">" + rObj.resultDetail.ProjectInfo.tag_array[i].tag_name + "</label>"
                            }
                            if (i === 1) {
                                fullTag += "<label id=\"label2\">" + rObj.resultDetail.ProjectInfo.tag_array[i].tag_name + "</label>"
                            }
                            if (i === 2) {
                                fullTag += "<label id=\"label3\">" + rObj.resultDetail.ProjectInfo.tag_array[i].tag_name + "</label>"
                            }

                        }

                        $('#p_info > tbody:last').append(
                            '<tr>' +
                            '<td width="200">프로젝트명</td>' +
                            '<td class="font-weight-normal">' + rObj.resultDetail.ProjectInfo.p_name + '</td>' +
                            '</tr>' +
                            '<tr>' +
                            '<td width="200">프로젝트 설명</td>' +
                            '<td class="font-weight-normal">' + rObj.resultDetail.ProjectInfo.p_description + '</td>' +
                            '</tr>' +
                            '<tr>' +
                            '<td width="200">사용 템플릿</td>' +
                            '<td class="font-weight-normal">' + rObj.resultDetail.ProjectInfo.tml_name + '</td>' +
                            '</tr>' +
                            '<tr>' +
                            '<td width="200">유출 상태</td>' +
                            '<td class="font-weight-normal">' + rObj.resultDetail.ProjectInfo.p_status_percent + ' %' + '</td>' +
                            '</tr>' +
                            '<tr>' +
                            '<td width="200">메일 전송률</td>' +
                            '<td class="font-weight-normal">' + rObj.resultDetail.ProjectInfo.progress_percent + ' %' + '</td>' +
                            '</tr>' +
                            '<tr>' +
                            '<td width="200">프로젝트 기간</td>' +
                            '<td class="font-weight-normal">' + rObj.resultDetail.ProjectInfo.start_date +
                            "&nbsp;&nbsp;&nbsp;&nbsp;~&nbsp;&nbsp;&nbsp;&nbsp;" +
                            rObj.resultDetail.ProjectInfo.end_date + '</td>' +
                            '</tr>' + // + rObjs.project_detail.end_date + '</td></tr>' +
                            '<tr>' +
                            '<td width="200">프로젝트 생성자</td>' +
                            '<td class="font-weight-normal">' + rObj.resultDetail.ProjectInfo.p_make_user + '</td>' +
                            '</tr>' +
                            '<tr>' +
                            '<td width="200">훈련 대상자 태그</td>' +
                            '<td class="font-weight-normal">' + fullTag + '</td>' +
                            '</tr>' +
                            '<tr>' +
                            '<td width="200">훈련 대상자 수</td>' +
                            '<td class="font-weight-normal">' + rObj.resultDetail.ProjectInfo.target_count + '</td>' +
                            '</tr>' +
                            '<tr>' +
                            '<td width="200">발송</td>' +
                            '<td class="font-weight-normal">' + rObj.resultDetail.ProjectInfo.send_count + '</td>' +
                            '</tr>' +
                            '<td width="200">발송 실패</td>' +
                            '<td class="font-weight-normal">' + rObj.resultDetail.ProjectInfo.send_fail_count + '</td>' +
                            '</tr>' +
                            '<tr>' +
                            '<td width="200">Email 열람</td>' +
                            '<td class="font-weight-normal">' + rObj.resultDetail.ProjectInfo.email_read + '</td>' +
                            '</tr>' +
                            '<tr>' +
                            '<td width="200">Link 접속</td>' +
                            '<td class="font-weight-normal">' + rObj.resultDetail.ProjectInfo.link_click + '</td>' +
                            '</tr>' +
                            '<tr>' +
                            '<td width="200">첨부파일 다운로드</td>' +
                            '<td class="font-weight-normal">' + rObj.resultDetail.ProjectInfo.download + '</td>' +
                            '</tr>' +
                            '<tr>' +
                            '<td width="200">프로젝트 생성일</td>' +
                            '<td class="font-weight-normal">' + rObj.resultDetail.ProjectInfo.p_created_time + '</td>' +
                            '</tr>' +
                            '<tr>' +
                            '<td width="200">프로젝트 최종 수정일</td>' +
                            '<td class="font-weight-normal">' + rObj.resultDetail.ProjectInfo.p_modified_time + '</td>' +
                            '</tr>'
                        );
                        warnLevel = '양호'
                        if (rObj.resultDetail.ProjectSummary.ResultOfAll.rate > 70) {
                            warnLevel = '심각'
                        } else if (rObj.resultDetail.ProjectSummary.ResultOfAll.rate > 30) {
                            warnLevel = '주의'
                        }
                        $('#totalResult > tbody:last').append(
                            '<tr>' +
                            '<td >전체</td>' +
                            '<td >' + rObj.resultDetail.ProjectSummary.ResultOfAll.infection_count +
                            ' / ' + rObj.resultDetail.ProjectSummary.ResultOfAll.total_count + ' 명' + '</td>' +
                            '<td >' + rObj.resultDetail.ProjectSummary.ResultOfAll.rate + ' %' + '</td>' +
                            '<td >' + warnLevel + '</td>' +
                            '</tr>'
                        );
                        $('#resultPerClassification > tbody:last').append(
                            '<tr>' +
                            '<td >태그</td>' +
                            '<td >' + rObj.resultDetail.ProjectSummary.ResultPerClassification.CTag.tag_name + '</td>' +
                            '<td >' + rObj.resultDetail.ProjectSummary.ResultPerClassification.CTag.infection_count +
                            ' / ' + rObj.resultDetail.ProjectSummary.ResultPerClassification.CTag.total_count + ' 명' + '</td>' +
                            '<td >' + rObj.resultDetail.ProjectSummary.ResultPerClassification.CTag.rate + ' %' + '</td>' +
                            '</tr>' +
                            '<tr>' +
                            '<td >소속</td>' +
                            '<td >' + rObj.resultDetail.ProjectSummary.ResultPerClassification.COrgan.organ_name + '</td>' +
                            '<td >' + rObj.resultDetail.ProjectSummary.ResultPerClassification.COrgan.infection_count +
                            ' / ' + rObj.resultDetail.ProjectSummary.ResultPerClassification.COrgan.total_count + ' 명' + '</td>' +
                            '<td >' + rObj.resultDetail.ProjectSummary.ResultPerClassification.COrgan.rate + ' %' + '</td>' +
                            '</tr>' +
                            '<tr>' +
                            '<td >직급</td>' +
                            '<td >' + rObj.resultDetail.ProjectSummary.ResultPerClassification.CPosition.position_name + '</td>' +
                            '<td >' + rObj.resultDetail.ProjectSummary.ResultPerClassification.CPosition.infection_count +
                            ' / ' + rObj.resultDetail.ProjectSummary.ResultPerClassification.CPosition.total_count + ' 명' + '</td>' +
                            '<td >' + rObj.resultDetail.ProjectSummary.ResultPerClassification.CPosition.rate + ' %' + '</td>' +
                            '</tr>'
                        );
                        for (let i = 0; i < rObj.resultDetail.ResultPerStatistic.PerTag.length; i++) {
                            $('#perTag > tbody:last').append(
                                '<tr>' +
                                '<td >' + rObj.resultDetail.ResultPerStatistic.PerTag[i].tag_name + '</td>' +
                                '<td ><progress class="valign-middle" value="' + rObj.resultDetail.ResultPerStatistic.PerTag[i].infection_count + '" max="' +
                                rObj.resultDetail.ResultPerStatistic.PerTag[i].total_count + '"></progress>' +
                                rObj.resultDetail.ResultPerStatistic.PerTag[i].rate + ' %(' + rObj.resultDetail.ResultPerStatistic.PerTag[i].infection_count +
                                ' / ' + rObj.resultDetail.ResultPerStatistic.PerTag[i].total_count + ' 명)' + '</td>' +
                                '</tr>'
                            )
                        }
                        for (let i = 0; i < rObj.resultDetail.ResultPerStatistic.PerOrgan.length; i++) {
                            $('#perOrgan > tbody:last').append(
                                '<tr>' +
                                '<td >' + rObj.resultDetail.ResultPerStatistic.PerOrgan[i].organ_name + '</td>' +
                                '<td ><progress class="valign-middle" value="' + rObj.resultDetail.ResultPerStatistic.PerOrgan[i].infection_count + '" max="' +
                                rObj.resultDetail.ResultPerStatistic.PerOrgan[i].total_count + '"></progress>' +
                                rObj.resultDetail.ResultPerStatistic.PerOrgan[i].rate + ' %(' + rObj.resultDetail.ResultPerStatistic.PerOrgan[i].infection_count +
                                ' / ' + rObj.resultDetail.ResultPerStatistic.PerOrgan[i].total_count + ' 명)' + '</td>' +
                                '</tr>'
                            )
                        }
                        for (let i = 0; i < rObj.resultDetail.ResultPerStatistic.PerPosition.length; i++) {
                            $('#perPosition > tbody:last').append(
                                '<tr>' +
                                '<td >' + rObj.resultDetail.ResultPerStatistic.PerPosition[i].position_name + '</td>' +
                                '<td ><progress class="valign-middle" value="' + rObj.resultDetail.ResultPerStatistic.PerPosition[i].infection_count + '" max="' +
                                rObj.resultDetail.ResultPerStatistic.PerPosition[i].total_count + '"></progress>' +
                                rObj.resultDetail.ResultPerStatistic.PerPosition[i].rate + ' %(' + rObj.resultDetail.ResultPerStatistic.PerPosition[i].infection_count +
                                ' / ' + rObj.resultDetail.ResultPerStatistic.PerPosition[i].total_count + ' 명)' + '</td>' +
                                '</tr>'
                            )
                        }
                    }

                } else if (r.status === 403) {
                    Refresh();
                    GetResult(p_no);
                }
            }
        };
        r.send();

    }

    function emptyTable() {
        $('#p_info > tbody').empty();
        $('#totalResult > tbody').empty();
        $('#resultPerClassification > tbody').empty();
        $('#perTag > tbody').empty();
        $('#perOrgan > tbody').empty();
        $('#perPosition > tbody').empty();
    }

    GetDashBoard();
    Tg_total();
    GetDashBoard_Info1();
    GetDashBoard_Info3();


    function toExcel() {
        if ("ActiveXObject" in window) {
            alert("Internet Explorer 브라우저에서는 지원되지 않는 기능 입니다.");
        } else {

            var cache = {};
            this.tmpl = function tmpl(str, data) {
                var fn = !/\W/.test(str) ? cache[str] = cache[str] || tmpl(document.getElementById(str).innerHTML) :
                    new Function("obj",
                        "var p=[],print=function(){p.push.apply(p,arguments);};" +
                        "with(obj){p.push('" +
                        str.replace(/[\r\t\n]/g, " ")
                            .split("{{").join("\t")
                            .replace(/((^|}})[^\t]*)'/g, "$1\r")
                            .replace(/\t=(.*?)}}/g, "',$1,'")
                            .split("\t").join("');")
                            .split("}}").join("p.push('")
                            .split("\r").join("\\'") + "');}return p.join('');");
                return data ? fn(data) : fn;
            };
            var tableToExcel = (function () {
                var uri = 'data:application/vnd.ms-excel;base64,',
                    template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{{=worksheet}}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body>{{for(var i=0; i<tables.length;i++){ }}<table>{{=tables[i]}}</table>{{ } }}</body></html>',
                    base64 = function (s) {
                        return window.btoa(unescape(encodeURIComponent(s)));
                    },
                    format = function (s, c) {
                        return s.replace(/{(\w+)}/g, function (m, p) {
                            return c[p];
                        });
                    };
                return function (tableList, name) {
                    if (!tableList.length > 0 && !tableList[0].nodeType) table = document.getElementById(table);
                    var tables = [];
                    for (var i = 0; i < 6; i++) {
                        tables.push(tableList[i].innerHTML);
                    }
                    var ctx = {
                        worksheet: name || 'Worksheet',
                        tables: tables
                    };
                    window.location.href = uri + base64(tmpl(template, ctx));
                };
            })();
            tableToExcel(document.getElementsByTagName("table"), "result");
        }
    }
</script>
</body>

</html>
